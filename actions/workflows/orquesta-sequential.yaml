version: 1.0
  
description: A basic sequential workflow.

input:
  - message

vars:
  - greeting: null
  - host_ip: null
  - host_name: null
  - service: null
  - key: true
  - msg_res: null
  
output:
  - greeting: <% ctx().greeting %>

tasks:
  View_VM_status:
    action: example.viewer
    input: 
      message: <% ctx().message %>
      VM: true
    next:
      - when: <% succeeded() %>
        publish: 
          - host_ip: <% result().result %>
        do: View_container_status
      - when: <% failed() %>
        publish:
          msg_res=<% result().result %>
        do: Repair_VM
  Repair_VM:
    action: example.deadman_remediations_action
    input: 
      message: <% ctx("msg_res") %>
      timeout_poll: 60
    next:
      - when: <% succeeded() %>
        publish:
        do: View_container_status
      - when: <% failed() %> 
        publish:
          - greeting: <% ctx("msg_res") %>, <% result().result %>
        do:
          - task5
  View_container_status:
    action: example.viewer
    input: 
      Docker: true
      hosts: <% ctx("host_ip") %>
      username: 'root'
      private_key: '/home/stanley/.ssh/id_rsa'
      cmd: 'systemctl is-enabled docker'
    next:
      - when: <% succeeded() %>
        publish: 
          greeting=<% result().result %>
        do: task3
      - when: <% failed() %>
        publish:
          - greeting: <% ctx("greeting") %>, <% result().result %>
        do:
          - task5
  task3:
    action: core.echo
    input: 
      message: <% ctx("greeting") %>
    next:
      - when: <% succeeded() %>
        publish:
          - greeting: <% ctx("greeting") %>, <% result().stdout %>
        do:
          - task4
  task4:
    action: core.echo message=<% ctx('greeting') %>
    next:
      - when: <% succeeded() %>
        publish: greeting=<% result().stdout %>
  task5:
    action: core.echo message="ERROR"
    next:
      - when: <% succeeded() %>
        publish: greeting=<% result().stdout %>
